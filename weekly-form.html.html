<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نموذج التبليغ الأسبوعي</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Tajawal', Arial, sans-serif;
            background-color: #f8f9fa; /* Softer background */
            margin: 0;
            padding: 20px; /* Add some padding for smaller screens */
            direction: rtl;
            color: #343a40; /* Default text color */
        }
        .container {
            max-width: 900px;
            margin: 30px auto; /* Adjusted margin */
            padding: 30px;    /* Increased padding */
            background-color: #ffffff;
            border-radius: 12px; /* Slightly more rounded */
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1); /* Softer shadow */
            border: 1px solid #e0e0e0; /* Subtle border */
        }
        h2 {
            text-align: center;
            margin-bottom: 30px; /* Increased margin */
            color: #0056b3; /* Primary color for main heading */
            font-weight: 700;
        }
        h3 {
            margin-top: 30px;
            margin-bottom: 15px;
            color: #333;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
            font-weight: 500;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px; /* Increased margin */
            color: #495057;     /* Darker label text */
            font-weight: 500;
        }
        .form-group input[type="text"],
        .form-group input[type="number"],
        .form-group input[type="date"],
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px; /* Increased padding */
            border-radius: 6px; /* Softer radius */
            border: 1px solid #ced4da; /* Standard border color */
            box-sizing: border-box;
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
            font-family: 'Tajawal', Arial, sans-serif; /* Ensure font consistency */
            background-clip: padding-box; /* Fix for select arrow visibility on some systems */
        }
        .form-group input[type="text"]:focus,
        .form-group input[type="number"]:focus,
        .form-group input[type="date"]:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            border-color: #80bdff;
            outline: 0;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }
        .form-group input[type="checkbox"] {
            margin-left: 8px; /* More space after checkbox */
            vertical-align: middle;
            width: auto; /* Override width:100% for checkbox */
        }
        .form-group label[for="zero_report"] {
            font-weight: normal;
            color: #495057;
            display: inline-block; /* Align with checkbox */
            margin-bottom: 0;
        }
        .form-group button {
            display: block;
            width: 100%;
            padding: 12px 15px; /* Adjusted padding */
            background-color: #007bff;
            color: #fff;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: background-color 0.15s ease-in-out, opacity 0.15s ease-in-out;
        }
        .form-group button:hover {
            background-color: #0056b3;
        }
        .form-group button:active {
            opacity: 0.85;
        }
        .form-group button.submit-report {
            background-color: #28a745;
            margin-top: 25px; /* Increased margin */
        }
        .form-group button.submit-report:hover {
            background-color: #1e7e34;
        }
        .aggregated-data {
            margin-top: 30px;
            background-color: #fdfdff; /* Very light background */
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 0.95em;
        }
        th, td {
            border: 1px solid #dee2e6; /* Lighter border */
            padding: 10px 12px; /* Adjusted padding */
            text-align: center;
            vertical-align: middle;
        }
        th {
            background-color: #e9ecef; /* Lighter header */
            color: #212529;      /* Darker header text */
            font-weight: 700; /* Bolder header */
        }
        tbody tr:nth-child(even) {
            background-color: #f8f9fa; /* Zebra striping */
        }
        tfoot tr {
            background-color: #e0e0e0; /* Slightly darker footer */
            font-weight: bold;
        }
        .hidden {
            display: none !important; /* Ensure it overrides other display properties if needed */
        }
        .individual-data-entry {
            border: 1px dashed #adb5bd; /* Softer dashed border */
            padding: 20px;
            margin-top: 15px;
            border-radius: 8px;
            background-color: #f8f9fa; /* Light bg for this section */
        }
        .info-text {
            font-size: 0.85em; /* Slightly smaller */
            color: #6c757d;   /* Muted color */
            margin-top: 5px;  /* Space above info text */
            margin-bottom: 10px;
            display: block; /* Ensure it takes its own line if needed */
        }
        #zero_report_message {
            text-align: center;
            padding: 15px;
            background-color: #d1ecf1; /* Info blue */
            border: 1px solid #bee5eb;
            color: #0c5460;
            border-radius: 6px;
            margin-bottom: 20px;
        }
         /* Style for select dropdown arrow */
        .form-group select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23007bff%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.4-5.4-13z%22%2F%3E%3C%2Fsvg%3E');
            background-repeat: no-repeat;
            background-position: left 0.75rem center; /* Adjusted for RTL */
            background-size: 0.65em auto;
            padding-right: 12px; /* Default padding */
            padding-left: 2.5rem; /* Space for arrow */
        }
        html[dir="rtl"] .form-group select {
            background-position: right 0.75rem center; /* Correct for RTL */
            padding-left: 12px;
            padding-right: 2.5rem;
        }

    </style>
</head>
<body>

<div class="container">
    <h2>نموذج التبليغ الأسبوعي</h2>

    <div class="form-group">
        <label for="reporting_week">الأسبوع الوبائي</label>
        <select id="reporting_week" name="reporting_week">
            <!-- Options will be populated by JavaScript -->
        </select>
    </div>

    <div class="form-group">
        <label for="disease">المرض المبلغ عنه</label>
        <select id="disease" name="disease">
            <option value="">-- اختر المرض --</option>
            <!-- Options will be populated by JavaScript -->
        </select>
    </div>
    <div class="form-group hidden" id="other_disease_group">
        <label for="other_disease_name">اسم المرض الآخر</label>
        <input type="text" id="other_disease_name" name="other_disease_name">
    </div>

    <div class="form-group">
        <input type="checkbox" id="zero_report" name="zero_report" onchange="toggleIndividualDataEntry()">
        <label for="zero_report">تبليغ صفري (لا توجد حالات لهذا المرض في هذا الأسبوع)</label>
    </div>

    <div id="individual_data_section">
        <h3>إدخال بيانات الحالات الفردية (إذا وجدت)</h3>
        <div class="individual-data-entry">
            <div class="form-group">
                <label for="birth_date">تاريخ الميلاد (لحساب العمر للمواليد تحت العامين تلقائياً)</label>
                <input type="date" id="birth_date" name="birth_date" onchange="calculateAgeFromBirthDate()">
            </div>
            <div class="form-group">
                <label for="age">العمر (بالسنوات، أو بالأشهر إذا أقل من سنتين)</label>
                <input type="number" id="age" name="age" min="0" step="any" placeholder="مثال: 5 لـ 5 سنوات، أو 0.5 لـ 6 أشهر">
                <small class="info-text">إذا كان العمر أقل من سنة، أدخل كسر عشري (مثال: 0.25 لـ 3 أشهر، 0.5 لـ 6 أشهر، 0.75 لـ 9 أشهر). إذا كان العمر سنة واحدة وأقل من سنتين (مثال: 1.5 لـ سنة و 6 أشهر)</small>
            </div>
            <div class="form-group">
                <label for="gender">الجنس</label>
                <select id="gender" name="gender">
                    <option value="male">ذكر</option>
                    <option value="female">أنثى</option>
                </select>
            </div>
            <div class="form-group">
                <label for="nationality">الجنسية</label>
                <select id="nationality" name="nationality">
                    <option value="libyan">ليبي</option>
                    <option value="non-libyan">غير ليبي</option>
                </select>
            </div>
            <div class="form-group">
                <label for="deceased">توفيت الحالة؟</label>
                <select id="deceased" name="deceased">
                    <option value="no">لا</option>
                    <option value="yes">نعم</option>
                </select>
            </div>
            <div class="form-group hidden" id="vaccination_status_group">
                <label for="vaccination_status">الحالة التطعيمية (خاصة بالمرض المحدد)</label>
                <select id="vaccination_status" name="vaccination_status">
                    <option value="vaccinated">مطعم</option>
                    <option value="not-vaccinated">غير مطعم</option>
                    <option value="partially-vaccinated">مطعم جزئياً</option>
                    <option value="unknown">غير معروف</option>
                </select>
            </div>
            <div class="form-group">
                <button type="button" onclick="addIndividualData()">إضافة بيانات الحالة</button>
            </div>
        </div>
    </div>

    <h3>البيانات التجميعية للأسبوع المحدد والمرض المحدد</h3>
    <div class="aggregated-data">
        <div id="zero_report_message" class="hidden" style="text-align: center; padding: 20px;">
            تم تسجيل تبليغ صفري لهذا الأسبوع والمرض.
        </div>
        <table>
            <thead>
                <tr>
                    <th>الفئات العمرية</th>
                    <th>ذكر</th>
                    <th>أنثى</th>
                    <th>ليبي</th>
                    <th>غير ليبي</th>
                    <th>وفيات</th>
                    <th class="vaccine-col hidden">مطعم</th>
                    <th class="vaccine-col hidden">غير مطعم</th>
                    <th class="vaccine-col hidden">مطعم جزئياً</th>
                    <th class="vaccine-col hidden">تطعيم غير معروف</th>
                    <th>المجموع</th>
                </tr>
            </thead>
            <tbody id="data_summary">
                <!-- سيتم ملء البيانات هنا -->
            </tbody>
            <tfoot>
                <tr id="total_summary_row">
                    <td>الإجمالي</td>
                    <td id="total_male">0</td>
                    <td id="total_female">0</td>
                    <td id="total_libyan">0</td>
                    <td id="total_non_libyan">0</td>
                    <td id="total_deceased">0</td>
                    <td id="total_vaccinated" class="vaccine-col hidden">0</td>
                    <td id="total_not_vaccinated" class="vaccine-col hidden">0</td>
                    <td id="total_partially_vaccinated" class="vaccine-col hidden">0</td>
                    <td id="total_unknown_vaccination" class="vaccine-col hidden">0</td>
                    <td id="grand_total">0</td>
                </tr>
            </tfoot>
        </table>
    </div>
    <div class="form-group">
        <button type="button" class="submit-report" onclick="submitWeeklyReport()">إرسال التقرير الأسبوعي</button>
    </div>
</div>

<script>
    const diseaseConfig = {
        "acute_flaccid_paralysis": { arabicName: "الشلل الرخو الحاد", vaccine: false },
        "anthrax": { arabicName: "الجمرة الخبيثة", vaccine: false },
        "any_disease_epidemic_international_concern": { arabicName: "أي مرض يأخذ شكل وبائي معد او يثير قلقا دوليا", vaccine: false },
        "cholera": { arabicName: "الهيضة (الكوليرا)", vaccine: false },
        "diphtheria": { arabicName: "الخناق (الدفتيريا)", vaccine: true },
        "food_poisoning": { arabicName: "التسمم الغذائي", vaccine: false },
        "measles": { arabicName: "الحصبة", vaccine: true },
        "meningitis": { arabicName: "الالتهاب السحائي", vaccine: true },
        "plague": { arabicName: "الطاعون", vaccine: false },
        "rubella": { arabicName: "الحصبة الألمانية", vaccine: true },
        "scorpion_sting": { arabicName: "لدغة العقرب", vaccine: false },
        "snake_bite": { arabicName: "لدغة الثعبان", vaccine: false },
        "neonatal_tetanus": { arabicName: "الكزاز الوليدي", vaccine: true },
        "epidemic_typhus": { arabicName: "التيفوس الوبائي", vaccine: false },
        "hemorrhagic_fevers": { arabicName: "الحميات النزفية", vaccine: false },
        "pertussis": { arabicName: "الشاهوق (السعال الديكي)", vaccine: true },
        "yellow_fever": { arabicName: "الحمى الصفراء", vaccine: true },
        "amoebic_dysentery": { arabicName: "الزحار الأميبي", vaccine: false },
        "animal_bite": { arabicName: "عضة الحيوان", vaccine: false },
        "brucellosis": { arabicName: "حمى متموجة مالطية", vaccine: false },
        "chickenpox": { arabicName: "الجديري (الجدري الكاذب)", vaccine: true },
        "covid19": { arabicName: "كوفيد - 19", vaccine: true },
        "leishmaniasis_cutaneous": { arabicName: "الليشمانيا (القرحة الشرقية)", vaccine: false },
        "hydatid_cysts": { arabicName: "الأكياس العذرية المائية", vaccine: false },
        "encephalitis": { arabicName: "التهاب الدماغ", vaccine: false },
        "gonorrhea": { arabicName: "السيلان", vaccine: false },
        "hepatitis_a": { arabicName: "التهاب الكبد الفيروسي ا", vaccine: true },
        "hepatitis_b": { arabicName: "التهاب الكبد الفيروسي ب", vaccine: true },
        "hepatitis_c": { arabicName: "التهاب الكبد الفيروسي ج", vaccine: false },
        "hiv_aids": { arabicName: "متلازمة العوز المناعي المكتسب - الايدز", vaccine: false },
        "influenza_seasonal": { arabicName: "النزلة الوافدة (الانفلونزا الموسمية)", vaccine: true },
        "leprosy": { arabicName: "الجذام", vaccine: false },
        "malaria": { arabicName: "البرداء (الملاريا)", vaccine: false },
        "drug_resistant_tuberculosis": { arabicName: "الدرن المقاوم للأدوية", vaccine: false }, // As per image, not marked VPD
        "mumps": { arabicName: "النكاف", vaccine: true },
        "tetanus": { arabicName: "الكزاز غير الوليدي", vaccine: true }, // Generic Tetanus is VPD
        "rsv": { arabicName: "التنفسي المخلوي", vaccine: false }, // As per image, not marked VPD
        "pulmonary_tuberculosis": { arabicName: "الدرن الرئوي", vaccine: true }, // BCG
        "rickettsial_fever": { arabicName: "حمى الريكتسيا", vaccine: false },
        "schistosomiasis": { arabicName: "البلهارسيا", vaccine: false },
        "syphilis": { arabicName: "الزهري", vaccine: false },
        "extrapulmonary_tuberculosis": { arabicName: "درن الأعضاء", vaccine: true }, // BCG
        "typhoid_paratyphoid_fever": { arabicName: "التيفويد والباراتيفوي د", vaccine: true }, // Typhoid vaccine
        "unspecified_viral_hepatitis": { arabicName: "التهاب كبدي فيروسي غير محدد", vaccine: false },
        "visceral_leishmaniasis": { arabicName: "الليشمانيا الحشوية", vaccine: false },
        "other": { arabicName: "مرض آخر (يرجى التحديد)", vaccine: 'ask' }
    };

    let weeklyData = {}; // Structure: { "week_disease": { ageGroups: {}, totals: {} } }
    const arabicMonths = ["يناير", "فبراير", "مارس", "أبريل", "مايو", "يونيو", "يوليو", "أغسطس", "سبتمبر", "أكتوبر", "نوفمبر", "ديسمبر"];


    document.addEventListener('DOMContentLoaded', function() {
        populateWeekDropdown();
        populateDiseaseDropdown();
        document.getElementById('reporting_week').onchange = handleWeekOrDiseaseChange;
        // Disease dropdown onchange is set within populateDiseaseDropdown

        updateAggregatedData(); // Initial empty table
        handleWeekOrDiseaseChange(); // To load data for default selected week/disease
    });

    /**
     * Calculates epidemiological week information (Sunday-Saturday week) for a given date.
     * The year of the epi week is determined by the year of its Thursday.
     * Week 1 is the week containing Jan 1st, or more precisely, the week whose Thursday is in the same year as Jan 1st
     * and is closest to Jan 1st. This aligns with common epi week definitions (e.g. MMWR-like).
     */
    function getSimpleEpiWeekInfo(date) {
        const d = new Date(date); // Work with a copy
        d.setHours(0, 0, 0, 0); // Standardize to start of day

        // Determine the Sunday of the week 'd' is in
        const dayOfWeek = d.getDay(); // 0 for Sunday, 1 for Monday, ...
        const currentWeekSunday = new Date(d);
        currentWeekSunday.setDate(d.getDate() - dayOfWeek);

        const currentWeekSaturday = new Date(currentWeekSunday);
        currentWeekSaturday.setDate(currentWeekSunday.getDate() + 6);

        // The year of the epi week is determined by its Thursday.
        let thursdayOfWeek = new Date(currentWeekSunday);
        thursdayOfWeek.setDate(currentWeekSunday.getDate() + 4); // Sunday=0, Thursday is day 4
        const epiYear = thursdayOfWeek.getFullYear();

        // Find the Sunday of the first epidemiological week of 'epiYear'.
        // The first epidemiological week of a year is the one that contains the first Thursday of that year.
        // So, find Jan 1st of epiYear, then find its Thursday. The week containing that Thursday is week 1.
        // The Sunday of that week is Thursday - 4 days.
        
        // More direct: The first Sunday of epi week 1 is the Sunday of the week containing Jan 1st of epiYear.
        // (This is a common simplified definition which is compatible with "Thursday rule" for year determination)
        const jan1OfEpiYear = new Date(epiYear, 0, 1); // Jan 1 of the epiYear
        jan1OfEpiYear.setHours(0,0,0,0);
        const dayOfJan1 = jan1OfEpiYear.getDay(); // 0 for Sunday
        
        const firstSundayOfEpiYear = new Date(jan1OfEpiYear);
        firstSundayOfEpiYear.setDate(jan1OfEpiYear.getDate() - dayOfJan1);

        // Calculate week number by counting Sundays from the firstSundayOfEpiYear
        const diffInMilliseconds = currentWeekSunday.getTime() - firstSundayOfEpiYear.getTime();
        const weekNum = Math.floor(diffInMilliseconds / (7 * 24 * 60 * 60 * 1000)) + 1;
        
        return {
            year: epiYear,
            weekNum: weekNum,
            startDate: currentWeekSunday,
            endDate: currentWeekSaturday
        };
    }

    function populateWeekDropdown() {
        const weekDropdown = document.getElementById('reporting_week');
        weekDropdown.innerHTML = ''; // Clear existing options

        const today = new Date(); // User's current system date
        const currentEpiWeek = getSimpleEpiWeekInfo(today);

        const previousWeekStartDate = new Date(currentEpiWeek.startDate);
        previousWeekStartDate.setDate(currentEpiWeek.startDate.getDate() - 7); // Go back 7 days for previous week's Sunday
        const previousEpiWeek = getSimpleEpiWeekInfo(previousWeekStartDate);

        const weeksToDisplay = [previousEpiWeek, currentEpiWeek]; // Order: previous, current

        weeksToDisplay.forEach((weekInfo, index) => {
            const startDay = weekInfo.startDate.getDate();
            const startMonthIndex = weekInfo.startDate.getMonth();
            const startMonthName = arabicMonths[startMonthIndex];
            
            const endDay = weekInfo.endDate.getDate();
            const endMonthIndex = weekInfo.endDate.getMonth();
            const endMonthName = arabicMonths[endMonthIndex];

            const optionText = `الأسبوع ${weekInfo.weekNum} (${weekInfo.year}) (من ${startDay} ${startMonthName} إلى ${endDay} ${endMonthName})`;
            const option = document.createElement('option');
            option.value = `${weekInfo.year}-W${String(weekInfo.weekNum).padStart(2, '0')}`;
            option.textContent = optionText;
            
            // Select the current week by default (it's the second item in weeksToDisplay)
            if (index === 1) { 
                option.selected = true;
            }
            weekDropdown.add(option);
        });
    }
    
    function populateDiseaseDropdown() {
        const diseaseSelect = document.getElementById('disease');
        diseaseSelect.innerHTML = '<option value="">-- اختر المرض --</option>'; // Clear existing, add default

        for (const key in diseaseConfig) {
            if (key === 'other') continue; // Add 'other' last
            const disease = diseaseConfig[key];
            const option = document.createElement('option');
            option.value = key;
            option.textContent = disease.arabicName;
            diseaseSelect.add(option);
        }
        // Add 'other' option
        const otherDisease = diseaseConfig.other;
        if (otherDisease) {
            const option = document.createElement('option');
            option.value = 'other';
            option.textContent = otherDisease.arabicName;
            diseaseSelect.add(option);
        }

        diseaseSelect.onchange = () => {
            toggleVaccineStatusField();
            handleWeekOrDiseaseChange(); 
            const selectedDisease = diseaseSelect.value;
            document.getElementById('other_disease_group').classList.toggle('hidden', selectedDisease !== 'other');
        };
    }


    function handleWeekOrDiseaseChange() {
        document.getElementById('zero_report').checked = false;
        toggleIndividualDataEntry(); 
        updateAggregatedData(); 
    }

    function toggleVaccineStatusField() {
        const diseaseSelect = document.getElementById('disease');
        const selectedDiseaseValue = diseaseSelect.value;
        const vaccineGroup = document.getElementById('vaccination_status_group');
        const vaccineCols = document.querySelectorAll('.vaccine-col');

        let showVaccineFields = false;
        if (selectedDiseaseValue && diseaseConfig[selectedDiseaseValue]) {
            const vaccineEligibility = diseaseConfig[selectedDiseaseValue].vaccine;
            if (vaccineEligibility === true || vaccineEligibility === 'ask') {
                showVaccineFields = true;
            }
        }

        vaccineGroup.classList.toggle('hidden', !showVaccineFields);
        // Make sure the table columns for vaccine status are also updated.
        // This needs to happen when updateAggregatedData is called too.
        // Call updateAggregatedData here to ensure table headers reflect change immediately
        updateAggregatedData();
    }

    function toggleIndividualDataEntry() {
        const zeroReportCheckbox = document.getElementById('zero_report');
        const individualDataSection = document.getElementById('individual_data_section');
        const zeroReportMessage = document.getElementById('zero_report_message');
        const dataSummaryTable = document.querySelector('.aggregated-data table');

        if (zeroReportCheckbox.checked) {
            individualDataSection.classList.add('hidden');
            zeroReportMessage.classList.remove('hidden');
            dataSummaryTable.classList.add('hidden');
            const currentKey = getCurrentDataKey();
            if (currentKey && weeklyData[currentKey]) {
                 // If switching to zero report, effectively clear data for this combo,
                 // or handle it such that submission knows it's zero.
                 // The current logic in submitWeeklyReport handles this well.
                 // We might want to clear the visual table if it was previously populated.
                 weeklyData[currentKey] = getNewDataSet(); // Reset data if becoming zero report
            }
        } else {
            individualDataSection.classList.remove('hidden');
            zeroReportMessage.classList.add('hidden');
            dataSummaryTable.classList.remove('hidden');
        }
        updateAggregatedData(); // Refresh table display based on new state
    }

    function calculateAgeFromBirthDate() {
        const birthDateInput = document.getElementById('birth_date').value;
        const ageInput = document.getElementById('age');
        if (birthDateInput) {
            const birthDate = new Date(birthDateInput);
            const today = new Date(); // Use user's current date for calculation
            
            // Check if birthDate is valid and not in the future
            if (isNaN(birthDate.getTime()) || birthDate > today) {
                ageInput.value = '';
                // Optionally alert the user about invalid date
                // alert("تاريخ الميلاد غير صالح أو في المستقبل.");
                return;
            }

            let ageYears = today.getFullYear() - birthDate.getFullYear();
            const m = today.getMonth() - birthDate.getMonth();
            if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) {
                ageYears--;
            }

            if (ageYears < 0) ageYears = 0; // Should not happen if birthDate <= today

            if (ageYears < 1) { // Less than 1 year (e.g., 0 to 11 months)
                let ageMonthsTotal = (today.getFullYear() - birthDate.getFullYear()) * 12;
                ageMonthsTotal += today.getMonth();
                ageMonthsTotal -= birthDate.getMonth();
                 if (today.getDate() < birthDate.getDate()) {
                    ageMonthsTotal--;
                }
                ageMonthsTotal = Math.max(0, ageMonthsTotal); // Ensure not negative
                ageInput.value = parseFloat((ageMonthsTotal / 12).toFixed(2)); 
            } else if (ageYears < 2) { // Between 1 and less than 2 years (e.g., 12 to 23 months)
                let totalMonths = (today.getFullYear() - birthDate.getFullYear()) * 12;
                totalMonths += today.getMonth();
                totalMonths -= birthDate.getMonth();
                if (today.getDate() < birthDate.getDate()) {
                    totalMonths--;
                }
                totalMonths = Math.max(0, totalMonths);
                
                const yearsPart = Math.floor(totalMonths / 12);
                const monthsPart = totalMonths % 12;
                ageInput.value = parseFloat((yearsPart + (monthsPart / 12)).toFixed(2));
            }
            else {
                ageInput.value = ageYears;
            }
        }
    }

    function getNewDataSet() {
        return {
            ageGroups: {},
            totals: {
                male: 0, female: 0, libyan: 0, "non-libyan": 0,
                deceased_yes: 0,
                vaccinated: 0, "not-vaccinated": 0, "partially-vaccinated": 0, "unknown": 0,
                grandTotal: 0
            }
        };
    }
    
    function getCurrentDataKey() {
        const week = document.getElementById('reporting_week').value;
        let disease = document.getElementById('disease').value;
        if (!week || !disease) return null; 
        
        if (disease === 'other') {
            const otherName = document.getElementById('other_disease_name').value.trim().toLowerCase().replace(/\s+/g, '_');
            if (otherName) disease = `other_${otherName}`;
            else return null; // Invalid if other is selected but no name
        }
        return `${week}_${disease}`;
    }

    function addIndividualData() {
        const currentKey = getCurrentDataKey();
        if (!currentKey) {
            alert("يرجى اختيار الأسبوع الوبائي والمرض المبلغ عنه (وتحديد اسم المرض الآخر إذا تم اختياره).");
            return;
        }

        if (!weeklyData[currentKey]) {
            weeklyData[currentKey] = getNewDataSet();
        }
        let currentReportData = weeklyData[currentKey];

        const ageStr = document.getElementById('age').value;
        if (ageStr === "" || isNaN(parseFloat(ageStr)) || parseFloat(ageStr) < 0) {
            alert("يرجى إدخال العمر بشكل صحيح (رقم موجب).");
            return;
        }
        const age = parseFloat(ageStr);

        const gender = document.getElementById('gender').value;
        const nationality = document.getElementById('nationality').value;
        const deceased = document.getElementById('deceased').value; 
        
        let vaccinationStatus = "unknown"; // Default if not relevant
        const selectedDiseaseValue = document.getElementById('disease').value;
        let diseaseIsVaccineRelevant = false;
        if (selectedDiseaseValue && diseaseConfig[selectedDiseaseValue]) {
             const vaccineEligibility = diseaseConfig[selectedDiseaseValue].vaccine;
             diseaseIsVaccineRelevant = (vaccineEligibility === true || vaccineEligibility === 'ask');
        }

        if (diseaseIsVaccineRelevant) {
            vaccinationStatus = document.getElementById('vaccination_status').value;
        }

        let ageGroupKey;
        if (age < 1) ageGroupKey = "<1 سنة";
        else if (age < 5) ageGroupKey = "1-4 سنوات";
        else if (age < 15) ageGroupKey = "5-14 سنة";
        else if (age < 30) ageGroupKey = "15-29 سنة";
        else if (age < 45) ageGroupKey = "30-44 سنة";
        else if (age < 60) ageGroupKey = "45-59 سنة";
        else ageGroupKey = "60+ سنة";

        if (!currentReportData.ageGroups[ageGroupKey]) {
            currentReportData.ageGroups[ageGroupKey] = {
                male: 0, female: 0, libyan: 0, "non-libyan": 0, deceased_yes: 0,
                vaccinated: 0, "not-vaccinated": 0, "partially-vaccinated": 0, "unknown": 0,
                total: 0
            };
        }

        let group = currentReportData.ageGroups[ageGroupKey];
        group[gender]++;
        group[nationality]++;
        if (deceased === 'yes') group.deceased_yes++;
        
        // Only count vaccination status if the disease is vaccine relevant
        if (diseaseIsVaccineRelevant) {
            group[vaccinationStatus]++;
        } else { // If not vaccine relevant, ensure these counts remain 0 or are not incremented
            // This is mostly handled by default, but good to be explicit if needed.
        }
        group.total++;

        currentReportData.totals[gender]++;
        currentReportData.totals[nationality]++;
        if (deceased === 'yes') currentReportData.totals.deceased_yes++;
        if (diseaseIsVaccineRelevant) {
            currentReportData.totals[vaccinationStatus]++;
        }
        currentReportData.totals.grandTotal++;

        updateAggregatedData();
        clearIndividualForm();
    }

    function clearIndividualForm() {
        document.getElementById('birth_date').value = '';
        document.getElementById('age').value = '';
        // document.getElementById('gender').selectedIndex = 0; // Optional: reset dropdowns
        // document.getElementById('nationality').selectedIndex = 0;
        // document.getElementById('deceased').selectedIndex = 0;
        // document.getElementById('vaccination_status').value = 'unknown'; // Reset to unknown or first option
    }

    function updateAggregatedData() {
        const dataSummaryBody = document.getElementById('data_summary');
        dataSummaryBody.innerHTML = ''; 

        const currentKey = getCurrentDataKey();
        const zeroReportChecked = document.getElementById('zero_report').checked;
        const dataSummaryTable = document.querySelector('.aggregated-data table');
        const zeroReportMessage = document.getElementById('zero_report_message');
        const vaccineTableCols = document.querySelectorAll('.vaccine-col'); // TH and TD elements

        // Determine if vaccine columns should be shown based on selected disease
        const selectedDiseaseValue = document.getElementById('disease').value;
        let showVaccineCols = false;
        if (selectedDiseaseValue && diseaseConfig[selectedDiseaseValue]) {
            const vaccineEligibility = diseaseConfig[selectedDiseaseValue].vaccine;
            showVaccineCols = (vaccineEligibility === true || vaccineEligibility === 'ask');
        }
        
        vaccineTableCols.forEach(col => col.classList.toggle('hidden', !showVaccineCols));


        // Reset total row display
        document.getElementById('total_male').textContent = '0';
        document.getElementById('total_female').textContent = '0';
        document.getElementById('total_libyan').textContent = '0';
        document.getElementById('total_non_libyan').textContent = '0';
        document.getElementById('total_deceased').textContent = '0';
        document.getElementById('total_vaccinated').textContent = '0';
        document.getElementById('total_not_vaccinated').textContent = '0';
        document.getElementById('total_partially_vaccinated').textContent = '0';
        document.getElementById('total_unknown_vaccination').textContent = '0';
        document.getElementById('grand_total').textContent = '0';


        if (zeroReportChecked) {
            zeroReportMessage.classList.remove('hidden');
            dataSummaryTable.classList.add('hidden');
            return; // Stop here if it's a zero report
        } else {
             zeroReportMessage.classList.add('hidden');
             dataSummaryTable.classList.remove('hidden');
        }

        if (!currentKey || !weeklyData[currentKey] || !weeklyData[currentKey].totals) {
            // No data for this key, or key is invalid, table remains empty (totals already reset)
            return; 
        }

        const currentReportData = weeklyData[currentKey];
        const ageOrder = ["<1 سنة", "1-4 سنوات", "5-14 سنة", "15-29 سنة", "30-44 سنة", "45-59 سنة", "60+ سنة"];
        
        // Ensure age groups are displayed in the correct order
        const sortedAgeGroupKeys = ageOrder.filter(ageKey => currentReportData.ageGroups[ageKey]);


        for (const ageGroup of sortedAgeGroupKeys) {
            const counts = currentReportData.ageGroups[ageGroup];
            if (!counts || counts.total === 0) continue; // Skip empty groups

            const row = dataSummaryBody.insertRow();
            row.insertCell().textContent = ageGroup;
            row.insertCell().textContent = counts.male;
            row.insertCell().textContent = counts.female;
            row.insertCell().textContent = counts.libyan;
            row.insertCell().textContent = counts['non-libyan'];
            row.insertCell().textContent = counts.deceased_yes;
            
            // Vaccine data cells
            const cellVaccinated = row.insertCell();
            cellVaccinated.textContent = counts.vaccinated;
            cellVaccinated.classList.add('vaccine-col'); // Class for dynamic show/hide
            cellVaccinated.classList.toggle('hidden', !showVaccineCols);

            const cellNotVaccinated = row.insertCell();
            cellNotVaccinated.textContent = counts['not-vaccinated'];
            cellNotVaccinated.classList.add('vaccine-col');
            cellNotVaccinated.classList.toggle('hidden', !showVaccineCols);
            
            const cellPartiallyVaccinated = row.insertCell();
            cellPartiallyVaccinated.textContent = counts['partially-vaccinated'];
            cellPartiallyVaccinated.classList.add('vaccine-col');
            cellPartiallyVaccinated.classList.toggle('hidden', !showVaccineCols);

            const cellUnknownVaccination = row.insertCell();
            cellUnknownVaccination.textContent = counts.unknown;
            cellUnknownVaccination.classList.add('vaccine-col');
            cellUnknownVaccination.classList.toggle('hidden', !showVaccineCols);
            
            row.insertCell().textContent = counts.total;
        }

        // Update footer totals
        const totals = currentReportData.totals;
        document.getElementById('total_male').textContent = totals.male;
        document.getElementById('total_female').textContent = totals.female;
        document.getElementById('total_libyan').textContent = totals.libyan;
        document.getElementById('total_non_libyan').textContent = totals['non-libyan'];
        document.getElementById('total_deceased').textContent = totals.deceased_yes;
        document.getElementById('total_vaccinated').textContent = totals.vaccinated;
        document.getElementById('total_not_vaccinated').textContent = totals['not-vaccinated'];
        document.getElementById('total_partially_vaccinated').textContent = totals['partially-vaccinated'];
        document.getElementById('total_unknown_vaccination').textContent = totals.unknown;
        document.getElementById('grand_total').textContent = totals.grandTotal;
    }

    function submitWeeklyReport() {
        const week = document.getElementById('reporting_week').value;
        let diseaseValue = document.getElementById('disease').value;
        const otherDiseaseName = document.getElementById('other_disease_name').value;

        if (!week) {
            alert("يرجى اختيار الأسبوع الوبائي.");
            return;
        }
        if (!diseaseValue) {
            alert("يرجى اختيار المرض المبلغ عنه.");
            return;
        }
        if (diseaseValue === 'other' && !otherDiseaseName.trim()) {
            alert("يرجى تحديد اسم المرض الآخر.");
            return;
        }
        
        const currentKey = getCurrentDataKey(); // Recalculate key, especially for 'other'
        const isZeroReport = document.getElementById('zero_report').checked;
        let reportDataToSend;
        
        let diseaseDisplayName = "";
        if (diseaseValue === 'other') {
            diseaseDisplayName = `أخرى: ${otherDiseaseName.trim()}`;
        } else if (diseaseConfig[diseaseValue]) {
            diseaseDisplayName = diseaseConfig[diseaseValue].arabicName;
        }


        if (isZeroReport) {
            reportDataToSend = {
                week: week,
                disease: diseaseDisplayName,
                isZeroReport: true,
                data: getNewDataSet() // Send empty structure for zero report consistency
            };
        } else {
            // Check if there is actually data for non-zero report
            if (!currentKey || !weeklyData[currentKey] || weeklyData[currentKey].totals.grandTotal === 0) {
                if (confirm("لم يتم إدخال أي حالات. هل ترغب في إرساله كتقرير صفري؟")) {
                     document.getElementById('zero_report').checked = true;
                     toggleIndividualDataEntry(); // This will update UI and potentially data
                     // Call submitWeeklyReport again, now it will be handled as a zero report
                     // Need to ensure the logic flow is correct here.
                     // The recursive call is fine because the state (zero_report checked) has changed.
                     submitWeeklyReport(); 
                     return;
                } else {
                    alert("لم يتم إدخال أي حالات. يرجى إضافة بيانات الحالات أو تحديد 'تبليغ صفري'.");
                    return;
                }
            }
            reportDataToSend = {
                week: week,
                disease: diseaseDisplayName,
                isZeroReport: false,
                data: weeklyData[currentKey]
            };
        }

        console.log("بيانات التقرير الأسبوعي:", JSON.stringify(reportDataToSend, null, 2));
        alert(`تم تجهيز التقرير للأسبوع ${week} بخصوص مرض ${reportDataToSend.disease}. \nالبيانات (انظر وحدة التحكم للمزيد): \nإجمالي الحالات: ${reportDataToSend.isZeroReport ? 0 : reportDataToSend.data.totals.grandTotal}`);

        // TODO: Send `reportDataToSend` to a server
        // Example:
        // fetch('/api/submit-report', {
        //     method: 'POST',
        //     headers: { 'Content-Type': 'application/json' },
        //     body: JSON.stringify(reportDataToSend)
        // })
        // .then(response => response.json())
        // .then(data => console.log('Success:', data))
        // .catch((error) => console.error('Error:', error));
    }
</script>

</body>
</html>